<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fangio Telecom - Base de Datos PtMP</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background: #081421;
      color: #e0f7fa;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .video-bg {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: -2;
      object-fit: cover;
      filter: brightness(0.25) blur(1px);
    }
    .overlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(8,20,33,0.7);
      z-index: -1;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 12px;
      position: relative;
      z-index: 1;
    }
    .header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 32px;
    }
    .logo {
      width: 110px;
      height: 110px;
      border-radius: 24px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      box-shadow: 0 4px 24px #00e6ff33;
    }
    .logo img {
      width: 90px;
      height: auto;
      display: block;
    }
    .titulo {
      font-size: 2.5rem;
      font-weight: 700;
      color: #00e6ff;
      text-shadow: 0 2px 16px #00e6ff55;
      margin-bottom: 6px;
      text-align: center;
    }
    .subtitulo {
      font-size: 1.2rem;
      color: #b2ebf2;
      margin-bottom: 12px;
      text-align: center;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 18px 32px;
      margin-bottom: 18px;
    }
    .form-grid label {
      font-weight: 600;
      color: #00bcd4;
    }
    .form-grid input {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1.5px solid #1e88e5;
      margin-top: 4px;
      background: #0b1a2a;
      color: #e0f7fa;
    }
    .btn {
      background: #00bcd4;
      color: #000;
      font-weight: 700;
      padding: 10px 24px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      margin: 6px 8px 6px 0;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #1e88e5;
      color: #fff;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 24px;
      background: #101a2a;
      color: #e0f7fa;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #00bcd433;
      text-align: center;
    }
    th {
      background: #0b111f;
      color: #00e6ff;
    }
    tr:hover {
      background: #1e88e522;
    }
    .badge-factible { background: #10b981; color: #fff; border-radius: 8px; padding: 2px 10px; font-weight: 700; }
    .badge-nofactible { background: #ef4444; color: #fff; border-radius: 8px; padding: 2px 10px; font-weight: 700; }
    .badge-indef { background: #f59e42; color: #fff; border-radius: 8px; padding: 2px 10px; font-weight: 700; }
    /* Torres multipunto */
    .torre-lado {
      position: fixed;
      top: 180px;
      width: 110px;
      z-index: 2;
      text-align: center;
    }
    .torre-lado.izq { left: 10px; }
    .torre-lado.der { right: 10px; }
    .torre-img {
      width: 90px;
      margin-top: 6px;
      filter: drop-shadow(0 0 18px #00e6ff66);
    }
    .torre-label {
      background: #101a2a;
      color: #00e6ff;
      border-radius: 12px;
      padding: 6px 0 2px 0;
      margin-bottom: 0;
      font-size: 1rem;
      font-weight: 700;
      box-shadow: 0 0 16px #00e6ff33;
    }
    @media (max-width: 900px) {
      .form-grid { grid-template-columns: repeat(2, 1fr); }
      .torre-lado { display: none; }
    }
    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
      .container { padding: 10px 2vw; }
      .header { margin-bottom: 16px; }
      .titulo { font-size: 1.4rem; }
    }
    .perfil-elevacion-box {
      background: #232933;
      border-radius: 28px;
      box-shadow: 0 0 24px #00e6ff22;
      padding: 28px 32px 24px 32px;
      margin: 36px auto 0 auto;
      max-width: 1100px;
      min-height: 260px;
      color: #e0f7fa;
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .perfil-elevacion-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #00e6ff;
      margin-bottom: 18px;
      text-align: center;
      letter-spacing: 1px;
    }
    .perfil-elevacion-content {
      width: 100%;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      color: #b2ebf2;
    }
    @media (max-width: 700px) {
      .perfil-elevacion-box {
        padding: 14px 4vw 14px 4vw;
        min-height: 120px;
      }
      .perfil-elevacion-title {
        font-size: 1.1rem;
      }
    }
    #perfil-elevacion-info b {
  color: #00e6ff;
  font-weight: 700;
}
.ptmp-bottom-panel {
  position: fixed;
  left: 50%;
  bottom: 32px;
  transform: translateX(-50%);
  background: #181f2a;
  border-radius: 18px;
  box-shadow: 0 4px 32px #00e6ff33;
  padding: 18px 32px 12px 32px;
  z-index: 100;
  min-width: 900px;
  max-width: 98vw;
  display: flex;
  flex-direction: column;
  align-items: center;
  border: 2px solid #00e6ff33;
}
.ptmp-bottom-flex {
  display: flex;
  align-items: flex-end;
  gap: 32px;
}
.ptmp-bottom-icons {
  display: flex;
  gap: 32px;
  align-items: flex-end;
}
.ptmp-bottom-label {
  color: #b2ebf2;
  font-size: 0.95rem;
  text-align: center;
  margin-top: 4px;
}
.ptmp-bottom-value {
  color: #00e6ff;
  font-size: 1.1rem;
  font-weight: 700;
  text-align: center;
}
.ptmp-bottom-profile {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.ptmp-bottom-pathinfo {
  color: #b2ebf2;
  font-size: 1.05rem;
  margin-top: 4px;
  text-align: center;
}
@media (max-width: 900px) {
  .ptmp-bottom-panel { min-width: 0; padding: 8px 2vw; }
  .ptmp-bottom-flex { flex-direction: column; align-items: center; gap: 12px; }
  .ptmp-bottom-profile { width: 100%; }
  #perfilElevacionPlotly { width: 100% !important; }
}
.ptmp-bottom-panel {
  position: fixed;
  left: 50%;
  bottom: 32px;
  transform: translateX(-50%);
  background: #181f2aee;
  border-radius: 22px;
  box-shadow: 0 4px 32px #00e6ff55;
  padding: 18px 32px 12px 32px;
  z-index: 100;
  min-width: 900px;
  max-width: 98vw;
  display: flex;
  flex-direction: column;
  align-items: center;
  border: 2px solid #00e6ff33;
  backdrop-filter: blur(6px);
  transition: box-shadow 0.2s;
}
.ptmp-bottom-panel:hover {
  box-shadow: 0 8px 48px #00e6ff99;
}
.ptmp-bottom-flex {
  display: flex;
  align-items: flex-end;
  gap: 38px;
}
.ptmp-bottom-icons {
  display: flex;
  gap: 38px;
  align-items: flex-end;
}
.ptmp-bottom-label {
  color: #b2ebf2;
  font-size: 1.02rem;
  text-align: center;
  margin-top: 4px;
  letter-spacing: 0.5px;
}
.ptmp-bottom-value {
  color: #00e6ff;
  font-size: 1.22rem;
  font-weight: 700;
  text-align: center;
  margin-top: 2px;
  text-shadow: 0 2px 8px #00e6ff44;
}
.ptmp-bottom-profile {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.ptmp-bottom-pathinfo {
  color: #b2ebf2;
  font-size: 1.09rem;
  margin-top: 6px;
  text-align: center;
  font-weight: 600;
  letter-spacing: 0.5px;
}
@media (max-width: 900px) {
  .ptmp-bottom-panel { min-width: 0; padding: 8px 2vw; }
  .ptmp-bottom-flex { flex-direction: column; align-items: center; gap: 12px; }
  .ptmp-bottom-profile { width: 100%; }
  #perfilElevacionPlotly { width: 100% !important; }
}
#cerrar-panel-ptmp:hover {
  color: #ef4444;
  background: #00e6ff22;
  border-radius: 50%;
}
.ptmp-bottom-panel {
  position: fixed;
  left: 50%;
  bottom: 32px;
  transform: translateX(-50%);
  z-index: 9999;
  /* ...resto de tu estilo... */
}
.leaflet-container {
  z-index: 1 !important;
}
  </style>
</head>
<body> 
  <video class="video-bg" src="https://dl.dropboxusercontent.com/scl/fi/isjx084d625twlii2vmkd/Proyecto-video.mp4?rlkey=k2dwu1ek0lt5w77whlzq80zes&st=4h4wxyq1" autoplay loop muted playsinline></video>
  <div class="overlay"></div>
  <div class="torre-lado izq">
    <div class="torre-label">
      <span>ID</span><br>
      <span>Nombre</span><br>
      <span>Altura m</span>
    </div>
    <div class="torre-svg">
      <svg width="60" height="100" viewBox="0 0 60 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="26" y="80" width="8" height="15" rx="4" fill="#b0bec5"/>
        <rect x="20" y="10" width="20" height="70" rx="10" fill="#e0e0e0" stroke="#00e6ff" stroke-width="2"/>
        <rect x="27" y="20" width="6" height="50" rx="3" fill="#00e6ff" opacity="0.7"/>
        <line x1="30" y1="20" x2="10" y2="90" stroke="#00e6ff" stroke-width="2"/>
        <line x1="30" y1="20" x2="50" y2="90" stroke="#00e6ff" stroke-width="2"/>
        <circle cx="30" cy="15" r="7" fill="#00e6ff" stroke="#fff" stroke-width="2"/>
        <circle cx="30" cy="15" r="3" fill="#fff"/>
      </svg>
    </div>
    <div class="torre-txt">Torre multipunto</div>
  </div>
  <div class="torre-lado der">
    <div class="torre-label">
      <span>ID</span><br>
      <span>Nombre</span><br>
      <span>Altura m</span>
    </div>
    <div class="torre-svg">
      <svg width="60" height="100" viewBox="0 0 60 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="26" y="80" width="8" height="15" rx="4" fill="#b0bec5"/>
        <rect x="20" y="10" width="20" height="70" rx="10" fill="#e0e0e0" stroke="#00e6ff" stroke-width="2"/>
        <rect x="27" y="20" width="6" height="50" rx="3" fill="#00e6ff" opacity="0.7"/>
        <line x1="30" y1="20" x2="10" y2="90" stroke="#00e6ff" stroke-width="2"/>
        <line x1="30" y1="20" x2="50" y2="90" stroke="#00e6ff" stroke-width="2"/>
        <circle cx="30" cy="15" r="7" fill="#00e6ff" stroke="#fff" stroke-width="2"/>
        <circle cx="30" cy="15" r="3" fill="#fff"/>
      </svg>
    </div>
    <div class="torre-txt">Torre multipunto</div>
  </div>
  <div class="container">
    <div class="header">
      <div class="logo">
        <img src="img/logo_empresa.png" alt="Fangio Telecom">
      </div>
      <div class="titulo">Fangio Telecom</div>
      <div class="subtitulo">Base de datos de Enlaces Punto a Multipunto (PtMP)</div>
    </div>
    <h3>Datos de la Estación Base</h3>
    <div class="form-grid">
      <div>
        <label for="idBase">ID Base</label>
        <input type="text" id="idBase" />
      </div>
      <div>
        <label for="nombreBase">Nombre Base</label>
        <input type="text" id="nombreBase" />
      </div>
      <div>
        <label for="latBase">Latitud Base</label>
        <input type="text" id="latBase" />
      </div>
      <div>
        <label for="lonBase">Longitud Base</label>
        <input type="text" id="lonBase" />
      </div>
      <div>
        <label for="alturaBase">Altura Base (m)</label>
        <input type="text" id="alturaBase" />
      </div>
      <div>
        <label for="tipoBase">Tipo de Torre Base</label>
        <input type="text" id="tipoBase" />
      </div>
      <div>
        <label for="transporteBase">Transporte Base</label>
        <input type="text" id="transporteBase" />
      </div>
      <div>
        <label for="frecuenciaBase">Frecuencia (GHz)</label>
        <input type="text" id="frecuenciaBase" value="5.8" />
      </div>
    </div>
    <hr style="margin:32px 0;">
    <h3>Agregar Cliente</h3>
    <div class="form-grid">
      <div>
        <label for="idCliente">ID Cliente</label>
        <input type="text" id="idCliente" />
      </div>
      <div>
        <label for="nombreCliente">Nombre Cliente</label>
        <input type="text" id="nombreCliente" />
      </div>
      <div>
        <label for="latCliente">Latitud Cliente</label>
        <input type="text" id="latCliente" />
      </div>
      <div>
        <label for="lonCliente">Longitud Cliente</label>
        <input type="text" id="lonCliente" />
      </div>
      <div>
        <label for="alturaCliente">Altura Cliente (m)</label>
        <input type="text" id="alturaCliente" />
      </div>
      <div>
        <label for="tipoCliente">Tipo de Torre Cliente</label>
        <input type="text" id="tipoCliente" />
      </div>
      <div>
        <label for="transporteCliente">Transporte Cliente</label>
        <input type="text" id="transporteCliente" />
      </div>
    </div>
    <button class="btn" onclick="agregarCliente()">Agregar Cliente</button>
    <hr style="margin:32px 0;">
    <h3>Clientes Registrados</h3>
<table id="tablaClientes">
  <thead>
    <tr>
      <th>ID Cliente</th>
      <th>Nombre</th>
      <th>Latitud</th>
      <th>Longitud</th>
      <th>Altura</th>
      <th>Tipo Torre</th>
      <th>Transporte</th>
      <th>Distancia (km)</th>
      <th>Factibilidad</th>
    </tr>
  </thead>
  <tbody id="tablaClientesBody"></tbody>
</table>
  </div>
  <div id="ptmp-bottom-panel" class="ptmp-bottom-panel" style="display:none; position:fixed;">
  <button id="cerrar-panel-ptmp" title="Cerrar" style="
    position:absolute;top:12px;right:16px;
    background:transparent;border:none;
    font-size:1.8rem;line-height:1;
    color:#00e6ff;cursor:pointer;
    z-index:10;transition:color 0.2s;">
    &times;
  </button>
  <div class="ptmp-bottom-flex">
    <div class="ptmp-bottom-icons">
      <div>
        <img src="https://cdn.jsdelivr.net/gh/feathericons/feather@4.29.0/icons/navigation.svg" width="32" style="filter:invert(60%)" alt="Azimuth"/>
        <div class="ptmp-bottom-label">Azimuth</div>
        <div class="ptmp-bottom-value" id="azimuth-value">--</div>
      </div>
      <div>
        <img src="https://cdn.jsdelivr.net/gh/feathericons/feather@4.29.0/icons/activity.svg" width="32" style="filter:invert(60%)" alt="Elevación"/>
        <div class="ptmp-bottom-label">Elevación</div>
        <div class="ptmp-bottom-value" id="elevacion-value">--</div>
      </div>
      <div>
        <img src="https://cdn.jsdelivr.net/gh/feathericons/feather@4.29.0/icons/arrow-up.svg" width="32" style="filter:invert(60%)" alt="Altura Base"/>
        <div class="ptmp-bottom-label">Altura Base</div>
        <div class="ptmp-bottom-value" id="altura-base-value">--</div>
      </div>
      <div>
        <img src="https://cdn.jsdelivr.net/gh/feathericons/feather@4.29.0/icons/arrow-down.svg" width="32" style="filter:invert(60%)" alt="Altura Cliente"/>
        <div class="ptmp-bottom-label">Altura Cliente</div>
        <div class="ptmp-bottom-value" id="altura-cliente-value">--</div>
      </div>
    </div>
  <div class="ptmp-bottom-profile">
  <div id="perfilElevacionPlotly" style="width:800px;height:320px;border-radius:14px;overflow:hidden;box-shadow:0 2px 16px #00e6ff33;max-width:90vw;"></div>
  <div style="display:flex;gap:32px;justify-content:center;margin:12px 0 0 0;">
    <div>
      <label style="color:#b2ebf2;font-size:0.95rem;">Altura Torre A</label>
      <input type="range" id="sliderAlturaA" min="1" max="120" value="10" style="width:120px;">
      <span id="sliderAlturaAValue" style="color:#00e6ff;font-weight:700;">10 m</span>
    </div>
    <div>
      <label style="color:#b2ebf2;font-size:0.95rem;">Altura Torre B</label>
      <input type="range" id="sliderAlturaB" min="1" max="120" value="10" style="width:120px;">
      <span id="sliderAlturaBValue" style="color:#00e6ff;font-weight:700;">10 m</span>
    </div>
  </div>
  <div class="ptmp-bottom-pathinfo" id="ptmp-bottom-pathinfo">Path profile: --</div>
</div>>
  </div>
</div>
      <div id="ptmp-mapa" style="width:100%;height:480px;border-radius:18px;box-shadow:0 2px 24px #00e6ff33;margin-bottom:32px;"></div>
    </div>
  </div>
  <script>
window.bases = [];
window.baseSeleccionada = null;

// Utilidades
function calcularDistancia(lat1, lon1, lat2, lon2) {
  const rad = x => x * Math.PI / 180;
  const R = 6371.0088;
  const φ1 = rad(lat1), φ2 = rad(lat2);
  const Δφ = rad(lat2 - lat1);
  const Δλ = rad(lon2 - lon1);
  const a = Math.sin(Δφ / 2) ** 2 +
            Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
function analizarFactibilidadPtMP(distanciaKm, alturaBase, alturaCliente, tipoBase, tipoCliente, fresnelObstruido, margenDespejeMetros = 1) {
  if (isNaN(distanciaKm) || distanciaKm <= 0) {
    return { estado: 'N/D', badge: 'badge-indef', motivo: 'Datos insuficientes' };
  }

  // ⚠️ Validación específica para E6-ST18 (Cliente)
  if ((tipoCliente || '').toUpperCase().includes('E6-ST18') && distanciaKm > 10) {
    return { estado: 'NO FACTIBLE', badge: 'badge-nofactible', motivo: 'Distancia excede límite de 10 km para E6-ST18' };
  }

  // Validación general de distancia para PtMP
  if (distanciaKm > 10) {
    return { estado: 'NO FACTIBLE', badge: 'badge-nofactible', motivo: 'Distancia excesiva para PtMP' };
  }

  if (alturaBase < 10 || alturaCliente < 5) {
    return { estado: 'NO FACTIBLE', badge: 'badge-nofactible', motivo: 'Altura insuficiente' };
  }

  if ((tipoBase || '').toLowerCase().includes('poste') || (tipoCliente || '').toLowerCase().includes('poste')) {
    return { estado: 'NO FACTIBLE', badge: 'badge-nofactible', motivo: 'Torre tipo poste no recomendada' };
  }

  if (fresnelObstruido) {
    return { estado: 'NO FACTIBLE', badge: 'badge-nofactible', motivo: 'Obstrucción en zona Fresnel' };
  }

  return { estado: 'FACTIBLE', badge: 'badge-factible', motivo: 'Enlace despejado' };
}

// Selector de bases
function actualizarSelectorBases() {
  let sel = document.getElementById('selectorBase');
  if (!sel) {
    // Si no existe, créalo y agrégalo arriba de los datos de la base
    const div = document.createElement('div');
    div.innerHTML = `
      <label for="selectorBase" style="font-weight:600;color:#00bcd4;">Selecciona Base:</label>
      <select id="selectorBase" onchange="cambiarBase()" style="margin:0 12px 12px 8px;padding:6px 12px;border-radius:8px;">
        <option value="">-- Nueva Base --</option>
      </select>
      <button class="btn" onclick="nuevaBase()">Nueva Base</button>
      <button class="btn" onclick="guardarBase()">Guardar Base</button>
    `;
    document.querySelector('.container').insertBefore(div, document.querySelector('.container').children[2]);
    sel = document.getElementById('selectorBase');
  }
  sel.innerHTML = `<option value="">-- Nueva Base --</option>`;
  window.bases.forEach(b => {
    sel.innerHTML += `<option value="${b.idBase}">${b.nombreBase} (${b.idBase})</option>`;
  });
  if (window.baseSeleccionada !== null && window.bases[window.baseSeleccionada]) {
    sel.value = window.bases[window.baseSeleccionada].idBase;
  } else {
    sel.value = '';
  }
}

function nuevaBase() {
  document.getElementById('idBase').value = '';
  document.getElementById('nombreBase').value = '';
  document.getElementById('latBase').value = '';
  document.getElementById('lonBase').value = '';
  document.getElementById('alturaBase').value = '';
  document.getElementById('tipoBase').value = 'E5 BSI';
  document.getElementById('transporteBase').value = 'Fibra óptica';
  document.getElementById('frecuenciaBase').value = '5.8';
  window.baseSeleccionada = null;
  renderTablaClientes();
  mostrarMapaPtMP();
  actualizarSelectorBases();
}
function limpiarClienteConDefault() {
  document.getElementById('idCliente').value = '';
  document.getElementById('nombreCliente').value = '';
  document.getElementById('latCliente').value = '';
  document.getElementById('lonCliente').value = '';
  document.getElementById('alturaCliente').value = ''; // ← Vacío para que tú lo propongas
  document.getElementById('tipoCliente').value = 'E6-ST18';
  document.getElementById('transporteCliente').value = 'Inalámbrico';
}

function guardarBase() {
  if (!document.getElementById('alturaBase').value) document.getElementById('alturaBase').value = '30';
  if (!document.getElementById('tipoBase').value) document.getElementById('tipoBase').value = 'E5 BSI';
  if (!document.getElementById('transporteBase').value) document.getElementById('transporteBase').value = 'Fibra óptica';
  if (!document.getElementById('frecuenciaBase').value) document.getElementById('frecuenciaBase').value = '5.8';
  const idBase = document.getElementById('idBase').value.trim();
  const nombreBase = document.getElementById('nombreBase').value.trim();
  const latBase = parseFloat(document.getElementById('latBase').value);
  const lonBase = parseFloat(document.getElementById('lonBase').value);
  const alturaBase = parseFloat(document.getElementById('alturaBase').value);
  const tipoBase = document.getElementById('tipoBase').value.trim();
  const transporteBase = document.getElementById('transporteBase').value.trim();
  const frecuenciaBase = parseFloat(document.getElementById('frecuenciaBase').value);

  if (!idBase || !nombreBase || isNaN(latBase) || isNaN(lonBase) || isNaN(alturaBase)) {
    alert('Completa los datos de la estación base.');
    return;
  }

  let idx = window.bases.findIndex(b => b.idBase === idBase);
  if (idx === -1) {
    window.bases.push({
      idBase, nombreBase, latBase, lonBase, alturaBase, tipoBase, transporteBase, frecuenciaBase,
      clientes: []
    });
    idx = window.bases.length - 1;
  } else {
    Object.assign(window.bases[idx], { nombreBase, latBase, lonBase, alturaBase, tipoBase, transporteBase, frecuenciaBase });
  }
  window.baseSeleccionada = idx;
  actualizarSelectorBases();
  renderTablaClientes();
  mostrarMapaPtMP();
  guardarDatosEnLocalStorage();
}

function cambiarBase() {
  const id = document.getElementById('selectorBase').value;
  const idx = window.bases.findIndex(b => b.idBase === id);
  if (idx === -1) {
    nuevaBase();
    return;
  }
  window.baseSeleccionada = idx;
  const base = window.bases[idx];
  document.getElementById('idBase').value = base.idBase;
  document.getElementById('nombreBase').value = base.nombreBase;
  document.getElementById('latBase').value = base.latBase;
  document.getElementById('lonBase').value = base.lonBase;
  document.getElementById('alturaBase').value = base.alturaBase;
  document.getElementById('tipoBase').value = base.tipoBase;
  document.getElementById('transporteBase').value = base.transporteBase;
  document.getElementById('frecuenciaBase').value = base.frecuenciaBase;
  renderTablaClientes();
  mostrarMapaPtMP();
}


function agregarCliente() {
  if (window.baseSeleccionada === null) {
    guardarBase();
    if (window.baseSeleccionada === null) return;
  }
  const base = window.bases[window.baseSeleccionada];
  const idCliente = document.getElementById('idCliente').value.trim();
  const nombreCliente = document.getElementById('nombreCliente').value.trim();
  const latCliente = parseFloat(document.getElementById('latCliente').value);
  const lonCliente = parseFloat(document.getElementById('lonCliente').value);
  const alturaCliente = parseFloat(document.getElementById('alturaCliente').value);
  const tipoCliente = document.getElementById('tipoCliente').value.trim();
  const transporteCliente = document.getElementById('transporteCliente').value.trim();
  if (!idCliente || !nombreCliente || isNaN(latCliente) || isNaN(lonCliente) || isNaN(alturaCliente)) {
    alert('Completa todos los datos del cliente.');
    return;
  }
  const distancia = calcularDistancia(base.latBase, base.lonBase, latCliente, lonCliente);
  base.clientes.push({
    idCliente,
    nombreCliente,
    latCliente,
    lonCliente,
    alturaCliente,
    tipoCliente,
    transporteCliente,
    distancia: distancia.toFixed(2),
    factibilidad: 'N/D',
    badge: 'badge-indef'
  });
  renderTablaClientes();
  mostrarMapaPtMP();
  limpiarClienteConDefault();
}
const iconBase = L.divIcon({
  html: `<svg width="38" height="38" viewBox="0 0 38 38"><circle cx="19" cy="19" r="18" fill="#00e6ff" stroke="#fff" stroke-width="2"/><path d="M19 8v22M8 19h22" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>`,
  className: '',
  iconSize: [38, 38],
  iconAnchor: [19, 19]
});
const iconCliente = L.divIcon({
  html: `<svg width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="14" fill="#10b981" stroke="#fff" stroke-width="2"/><circle cx="16" cy="16" r="6" fill="#fff" stroke="#10b981" stroke-width="2"/></svg>`,
  className: '',
  iconSize: [32, 32],
  iconAnchor: [16, 16]
});

// Tabla de clientes
function renderTablaClientes() {
  const tbody = document.getElementById('tablaClientes').querySelector('tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  if (window.baseSeleccionada === null) return;

  const base = window.bases[window.baseSeleccionada];
  if (!base || !base.clientes) return;

  base.clientes.forEach((c, idx) => {
    const fila = document.createElement('tr');

    // Badge visual para E6-ST18
    let badgeHTML = '';
    if ((c.tipoCliente || '').toUpperCase() === 'E6-ST18') {
      badgeHTML = `<span style="background:#00e6ff;color:#181f2a;font-size:0.85em;padding:2px 8px;border-radius:8px;margin-left:6px;font-weight:700;">E6-ST18</span>`;
    }

    fila.innerHTML = `
      <td>${c.idCliente}</td>
      <td>${c.nombreCliente} ${badgeHTML}</td>
      <td>${c.latCliente}</td>
      <td>${c.lonCliente}</td>
      <td>${c.alturaCliente}</td>
      <td>${c.tipoCliente}</td>
      <td>${c.transporteCliente}</td>
      <td>${c.distancia}</td>
      <td><span class="${c.badge}">${c.factibilidad}</span></td>
    `;

    fila.style.cursor = 'pointer';
    fila.onclick = () => {
      const frecuencia = base.frecuenciaBase || 5.8;
      const datos = {
        idA: base.idBase,
        nombreA: base.nombreBase,
        latA: base.latBase,
        lonA: base.lonBase,
        alturaA: base.alturaBase,
        idB: c.idCliente,
        nombreB: c.nombreCliente,
        latB: parseFloat(c.latCliente),
        lonB: parseFloat(c.lonCliente),
        alturaB: parseFloat(c.alturaCliente),
        frecuencia: frecuencia
      };
      mostrarPerfilElevacionDesdeDatos(datos, true);
    };

    tbody.appendChild(fila);
  });
}

// Mapa
let map, capaClientes;
function mostrarMapaPtMP() {
  if (window.baseSeleccionada === null) {
    document.getElementById('ptmp-mapa').innerHTML = '<div style="color:#888;text-align:center;padding:40px;">Selecciona o crea una base para ver el mapa.</div>';
    if (map) { map.remove(); map = null; }
    return;
  }
  const base = window.bases[window.baseSeleccionada];
  const latBase = base.latBase;
  const lonBase = base.lonBase;
  const nombreBase = base.nombreBase;
  const clientes = base.clientes;

  if (isNaN(latBase) || isNaN(lonBase)) {
    document.getElementById('ptmp-mapa').innerHTML = '<div style="color:#888;text-align:center;padding:40px;">Ingresa los datos de la base para ver el mapa.</div>';
    if (map) { map.remove(); map = null; }
    return;
  }
  if (map) {
    map.remove();
    map = null;
  }
  map = L.map('ptmp-mapa').setView([latBase, lonBase], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  capaClientes = L.layerGroup().addTo(map);

  L.marker([latBase, lonBase], {icon: iconBase})
    .addTo(capaClientes)
    .bindTooltip(`<b>Radio Base</b><br>${nombreBase}`, {permanent: false, direction: 'top'});

  clientes.forEach(c => {
    const lat = parseFloat(c.latCliente);
    const lon = parseFloat(c.lonCliente);
    if (!isNaN(lat) && !isNaN(lon)) {
      L.polyline([[latBase, lonBase], [lat, lon]], {color:'#00e6ff', weight:3, opacity:0.7, dashArray:'6 6'}).addTo(capaClientes);
      L.marker([lat, lon], {icon: iconCliente})
        .addTo(capaClientes)
        .bindTooltip(`<b>Cliente:</b> ${c.nombreCliente}<br><b>ID:</b> ${c.idCliente}`, {permanent: false, direction: 'top'});
    }
  });

  const puntos = [[latBase, lonBase], ...clientes.map(c => [parseFloat(c.latCliente), parseFloat(c.lonCliente)])];
  const bounds = L.latLngBounds(puntos.filter(([lat,lon])=>!isNaN(lat)&&!isNaN(lon)));
  if (bounds.isValid()) map.fitBounds(bounds, {padding:[40,40]});
}
async function getElevacionesOpenTopoData(locations) {
  const chunkSize = 100;
  let elevaciones = [];
  for (let i = 0; i < locations.length; i += chunkSize) {
    const chunk = locations.slice(i, i + chunkSize);
    const locationsStr = chunk.map(([lat, lon]) => `${lat},${lon}`).join('|');
    const url = `https://api.opentopodata.org/v1/srtm90m?locations=${locationsStr}`;
    const resp = await fetch(url);
    const data = await resp.json();
    if (!data.results || !data.results.length) {
      throw new Error('No se pudo obtener elevación');
    }
    elevaciones = elevaciones.concat(data.results.map(r => r.elevation));
    await new Promise(res => setTimeout(res, 300));
  }
  return elevaciones;
}
async function getElevacionesOpenElevation(locations) {
  const chunkSize = 100;
  let elevaciones = [];
  for (let i = 0; i < locations.length; i += chunkSize) {
    const chunk = locations.slice(i, i + chunkSize);
    const locationsStr = chunk.map(([lat, lon]) => `${lat},${lon}`).join('|');
    const url = `https://api.open-elevation.com/api/v1/lookup?locations=${locationsStr}`;
    const resp = await fetch(url);
    const data = await resp.json();
    if (!data.results || !data.results.length) {
      throw new Error('No se pudo obtener elevación');
    }
    elevaciones = elevaciones.concat(data.results.map(r => r.elevation));
    await new Promise(res => setTimeout(res, 300));
  }
  return elevaciones;
}
let datosPerfilActual = null;
let idxClientePerfil = null;

async function actualizarPerfilDesdeSliders() {
  if (!datosPerfilActual) return;
  const alturaA = parseInt(document.getElementById('sliderAlturaA').value, 10);
  const alturaB = parseInt(document.getElementById('sliderAlturaB').value, 10);
  document.getElementById('sliderAlturaAValue').textContent = alturaA + ' m';
  document.getElementById('sliderAlturaBValue').textContent = alturaB + ' m';
  datosPerfilActual.alturaA = alturaA;
  datosPerfilActual.alturaB = alturaB;
  if (window.baseSeleccionada !== null) {
    window.bases[window.baseSeleccionada].alturaBase = alturaA;
    if (idxClientePerfil !== null) {
      window.bases[window.baseSeleccionada].clientes[idxClientePerfil].alturaCliente = alturaB;
      renderTablaClientes();
      guardarDatosEnLocalStorage();
    }
  }
  await mostrarPerfilElevacionDesdeDatos(datosPerfilActual, false);
}
async function mostrarPerfilElevacionDesdeDatos(datos, actualizarSliders = true) {
  const idA = datos.idA || datos['idA'] || '';
  const nombreA = datos.nombreA || datos['nombreA'] || '';
  const alturaA = parseFloat(datos.alturaA || datos['Altura Torre A']) || 0;
  const idB = datos.idB || datos['idB'] || '';
  const nombreB = datos.nombreB || datos['nombreB'] || '';
  const alturaB = parseFloat(datos.alturaB || datos['Altura Torre B']) || 0;
  const latA = parseFloat(datos.latA || datos['Latitud A']);
  const lonA = parseFloat(datos.lonA || datos['Longitud A']);
  const latB = parseFloat(datos.latB || datos['Latitud B']);
  const lonB = parseFloat(datos.lonB || datos['Longitud B']);
  const frecuenciaGHz = parseFloat(datos.frecuencia || datos['Frecuencia']);
  const numPuntos = 100;

  document.getElementById('ptmp-bottom-panel').style.display = 'block';
  document.getElementById('altura-base-value').textContent = alturaA + ' m';
  document.getElementById('altura-cliente-value').textContent = alturaB + ' m';

  function calcularAzimuth(lat1, lon1, lat2, lon2) {
    const toRad = deg => deg * Math.PI / 180;
    const toDeg = rad => rad * 180 / Math.PI;
    const dLon = toRad(lon2 - lon1);
    const y = Math.sin(dLon) * Math.cos(toRad(lat2));
    const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
              Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
    let brng = Math.atan2(y, x);
    brng = toDeg(brng);
    return (brng + 360) % 360;
  }
  function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  const azimuth = (!isNaN(latA) && !isNaN(lonA) && !isNaN(latB) && !isNaN(lonB))
    ? calcularAzimuth(latA, lonA, latB, lonB).toFixed(1) + '°'
    : '--';
  document.getElementById('azimuth-value').textContent = azimuth;
  document.getElementById('elevacion-value').textContent = '--';

  if (
    isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB) ||
    isNaN(alturaA) || isNaN(alturaB) || isNaN(frecuenciaGHz)
  ) {
    document.getElementById('perfilElevacionPlotly').innerHTML =
      '<div style="color:#e53935;padding:30px;text-align:center;">Datos insuficientes para generar el perfil de elevación.</div>';
    document.getElementById('ptmp-bottom-pathinfo').textContent = 'Path profile: --';
    return;
  }
  const puntos = [];
  for (let i = 0; i < numPuntos; i++) {
    const lat = latA + (latB - latA) * (i / (numPuntos - 1));
    const lon = lonA + (lonB - lonA) * (i / (numPuntos - 1));
    puntos.push([lat, lon]);
  }

  try {
const elevaciones = await getElevacionesConRespaldo(puntos);

    const distanciaKm = calcularDistancia(latA, lonA, latB, lonB);
    const h1 = elevaciones[0] + alturaA;
    const h2 = elevaciones[elevaciones.length - 1] + alturaB;
    const lineaVista = elevaciones.map((_, i) =>
      h1 + (h2 - h1) * (i / (numPuntos - 1))
    );
  const c = 299792458; // velocidad de la luz (m/s)
const frecuenciaHz = frecuenciaGHz * 1e9;
const lambda = c / frecuenciaHz;
const n = 1; // primera zona de Fresnel

let fresnelSup = [], fresnelInf = [];
for (let i = 0; i < numPuntos; i++) {
  const d1 = distanciaKm * 1000 * (i / (numPuntos - 1));
  const d2 = distanciaKm * 1000 - d1;
  let F = 0;
  if (d1 + d2 > 0) {
    F = Math.sqrt((n * lambda * d1 * d2) / (d1 + d2));
  }
  // 60% de la zona de Fresnel
  fresnelSup.push(lineaVista[i] + 0.6 * F);
  fresnelInf.push(lineaVista[i] - 0.6 * F);
}
    let fresnelObstruido = false;
    for (let i = 0; i < elevaciones.length; i++) {
   if (elevaciones[i] > fresnelInf[i] - 1) { // margen de 1 metro
    fresnelObstruido = true;
    break;
  }
  }
    const distancias = elevaciones.map((_, i) => +(distanciaKm * i / (numPuntos - 1)).toFixed(3));
    const torreA = {
      x: [0, 0],
      y: [elevaciones[0], elevaciones[0] + alturaA],
      name: `Torre A (${alturaA} m)`,
      mode: 'lines+markers',
      line: { color: '#00e6ff', width: 6 },
      marker: { size: 10, color: '#00e6ff' },
      showlegend: true
    };
    const torreB = {
      x: [distanciaKm, distanciaKm],
      y: [elevaciones[elevaciones.length - 1], elevaciones[elevaciones.length - 1] + alturaB],
      name: `Torre B (${alturaB} m)`,
      mode: 'lines+markers',
      line: { color: '#e53935', width: 6 },
      marker: { size: 10, color: '#e53935' },
      showlegend: true
    };
    const minElev = Math.min(...elevaciones);
    const maxElev = Math.max(...elevaciones);
const margen = Math.max(20, (maxElev - minElev) * 0.7); // margen mayor para resaltar el relieve


const yaxisRange = [minElev - margen, maxElev + margen];
    Plotly.newPlot('perfilElevacionPlotly', [
     {
       x: distancias,
       y: elevaciones,
       name: 'Terreno',
       type: 'scatter',
       mode: 'lines',
       fill: 'tozeroy',
       fillcolor: 'rgba(160, 110, 60, 0.35)', // marrón claro, más natural
       line: { shape: 'spline', color: '#8d5524', width: 2.5 }, // marrón oscuro
       hovertemplate: 'Distancia: %{x:.2f} km<br>Elevación: %{y:.0f} m<extra></extra>'
    },
      {
        ...torreA,
        line: { color: '#00e676', width: 6 },
        marker: { size: 10, color: '#00e676' }
      },
      {
        ...torreB,
        line: { color: '#2979ff', width: 6 },
        marker: { size: 10, color: '#2979ff' }
      },
      {
        x: distancias,
        y: lineaVista,
        name: 'Línea de Vista',
        type: 'scatter',
        mode: 'lines',
        line: { color: '#b4ec51', width: 3, dash: 'solid' }
      },
      {
        x: [...distancias, ...distancias.slice().reverse()],
        y: [...fresnelSup, ...fresnelInf.slice().reverse()],
        name: 'Zona Fresnel (60%)',
        type: 'scatter',
        mode: 'lines',
        fill: 'toself',
        fillcolor: 'rgba(180,236,81,0.10)',
        line: { color: '#b4ec51', width: 1, dash: 'dot' },
        hoverinfo: 'skip',
        showlegend: true
      }
    ], {
      title: '',
      xaxis: {
        title: '',
        zeroline: false,
        gridcolor: '#444',
        tickfont: { color: '#fff' },
        showgrid: true,
        showline: false
      },
      yaxis: {
        title: '',
        zeroline: false,
        gridcolor: '#444',
        tickfont: { color: '#fff' },
        showgrid: true,
        showline: false,
        range: yaxisRange
      },
      legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.2, font: { color: '#fff' } },
      plot_bgcolor: '#232933',
      paper_bgcolor: '#232933',
      font: { color: '#fff', family: 'Inter, sans-serif' },
      margin: { t: 10, l: 40, r: 10, b: 40 },
      dragmode: 'pan'
    }, {responsive: true, displayModeBar: false, scrollZoom: true });

    let factibilidad = '';
    let color = '';
    if (alturaA > 0 && alturaB > 0) {
      let obstruido = false;
      for (let i = 0; i < elevaciones.length; i++) {
        if (elevaciones[i] > fresnelSup[i]) {
          obstruido = true;
          break;
        }
      }
      if (obstruido) {
        factibilidad = 'Obstruido';
        color = '#ef4444';
      } else {
        factibilidad = 'Clear LoS';
        color = '#10b981';
      }
    } else {
      factibilidad = 'Requiere análisis';
      color = '#f59e42';
    }
    document.getElementById('ptmp-bottom-pathinfo').innerHTML =
      `<span style="color:${color};">Path profile: ${factibilidad} (${distanciaKm.toFixed(3)} km)</span>`;
    if (actualizarSliders) {
      datosPerfilActual = {...datos};
      idxClientePerfil = null;
      if (window.baseSeleccionada !== null && datos.idB) {
        idxClientePerfil = window.bases[window.baseSeleccionada].clientes.findIndex(
          c => c.idCliente == datos.idB
        );
      }
      document.getElementById('sliderAlturaA').value = datos.alturaA || datos['Altura Torre A'] || 10;
      document.getElementById('sliderAlturaB').value = datos.alturaB || datos['Altura Torre B'] || 10;
      document.getElementById('sliderAlturaAValue').textContent = (datos.alturaA || datos['Altura Torre A'] || 10) + ' m';
      document.getElementById('sliderAlturaBValue').textContent = (datos.alturaB || datos['Altura Torre B'] || 10) + ' m';
    }

  } catch (error) {
  document.getElementById('perfilElevacionPlotly').innerHTML =
    `<div style="color:#e53935;padding:30px;text-align:center;">Error al consultar OpenTopoData.<br>${error.message || error}</div>`;
  document.getElementById('ptmp-bottom-pathinfo').textContent = 'Path profile: --';
}
}
async function getElevacionesConRespaldo(locations) {
  try {
    return await getElevacionesOpenTopoData(locations);
  } catch (e) {
    console.warn('Fallo OpenTopoData, usando Open-Elevation:', e);
    return await getElevacionesOpenElevation(locations);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('sliderAlturaA').addEventListener('input', actualizarPerfilDesdeSliders);
  document.getElementById('sliderAlturaB').addEventListener('input', actualizarPerfilDesdeSliders);
});

document.getElementById('cerrar-panel-ptmp').onclick = function() {
  document.getElementById('ptmp-bottom-panel').style.display = 'none';
};

function guardarDatosEnLocalStorage() {
  localStorage.setItem('fangioBases', JSON.stringify(window.bases));
  localStorage.setItem('fangioBaseSeleccionada', window.baseSeleccionada);
}
function cargarDatosDeLocalStorage() {
  const bases = localStorage.getItem('fangioBases');
  if (bases) {
    window.bases = JSON.parse(bases);
  }
  const baseSel = localStorage.getItem('fangioBaseSeleccionada');
  if (baseSel !== null) {
    window.baseSeleccionada = baseSel === "null" ? null : Number(baseSel);
  }
}
window.onload = function() {
  cargarDatosDeLocalStorage();
  actualizarSelectorBases();
  renderTablaClientes();
  mostrarMapaPtMP();
  limpiarClienteConDefault();
};

</script>
  

</body>
</html>
